<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genshin Chat</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ================================================================
           Genshin Dialogue UI â€” Authentic Full-screen Recreation
           Reference: Genshin Impact 4.x NPC Dialogue Screen
           ================================================================ */

        body {
            background: transparent;
            color: var(--gi-text-light);
            font-size: 15px;
            line-height: 1.8;
            user-select: none;
        }

        .dialogue-root {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            pointer-events: none;
        }

        .dialogue-root>* {
            pointer-events: auto;
        }

        /* â”€â”€ Top Bar: Auto Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .top-bar {
            position: absolute;
            top: 16px;
            left: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 14px;
            background: none;
            border: none;
            color: var(--gi-text-dim);
            font-family: var(--gi-font-sans);
            font-size: 13px;
            cursor: pointer;
            transition: color var(--gi-duration) var(--gi-ease),
                opacity var(--gi-duration) var(--gi-ease);
            opacity: 0.7;
            letter-spacing: 0.5px;
        }

        .auto-btn:hover {
            color: var(--gi-text-light);
            opacity: 1;
        }

        .auto-btn.active {
            color: var(--gi-text-gold);
            opacity: 1;
        }

        .auto-btn .play-icon {
            font-size: 11px;
        }

        /* â”€â”€ History Toggle (top-left below auto) â”€â”€â”€â”€â”€â”€â”€â”€ */
        .subtitle-text {
            position: absolute;
            top: 44px;
            left: 20px;
            font-size: 11px;
            color: var(--gi-text-dim);
            letter-spacing: 1px;
            opacity: 0.6;
        }

        /* â”€â”€ Right-side Options Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .options-area {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 280px;
            z-index: 10;
            max-height: 60vh;
            overflow-y: auto;
        }

        .option-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--gi-dark-panel);
            border: 1px solid var(--gi-border-gold-dim);
            border-radius: var(--gi-radius-sm);
            color: var(--gi-text-light);
            font-family: var(--gi-font-sans);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--gi-duration) var(--gi-ease);
            animation: gi-slideInRight 0.3s var(--gi-ease) backwards;
            text-align: left;
            line-height: 1.5;
        }

        .option-btn:nth-child(1) {
            animation-delay: 0.05s;
        }

        .option-btn:nth-child(2) {
            animation-delay: 0.1s;
        }

        .option-btn:nth-child(3) {
            animation-delay: 0.15s;
        }

        .option-btn:nth-child(4) {
            animation-delay: 0.2s;
        }

        .option-btn:hover {
            background: var(--gi-dark-hover);
            border-color: var(--gi-border-gold);
            transform: translateX(-4px);
        }

        .option-btn:active {
            transform: translateX(-2px) scale(0.98);
        }

        .option-dots {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
        }

        .option-dots .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--gi-text-gold);
            opacity: 0.8;
        }

        .option-text {
            flex: 1;
            min-width: 0;
        }

        /* Custom input option */
        .option-btn.custom-input {
            border-color: var(--gi-gold-dim);
        }

        .option-btn.custom-input .option-dots .dot {
            background: var(--gi-accent);
        }

        /* â”€â”€ Chat History (hidden by default, shown on toggle) â”€ */
        .history-panel {
            position: absolute;
            top: 64px;
            left: 16px;
            bottom: 200px;
            width: 300px;
            display: flex;
            flex-direction: column;
            background: var(--gi-dark-panel);
            border: 1px solid var(--gi-border-gold-dim);
            border-radius: var(--gi-radius-md);
            overflow: hidden;
            z-index: 5;
            animation: gi-fadeIn 0.2s var(--gi-ease);
            pointer-events: auto;
        }

        .history-panel.hidden {
            display: none;
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 14px;
            border-bottom: 1px solid var(--gi-border-gold-dim);
        }

        .history-header span {
            font-size: 11px;
            color: var(--gi-text-gold);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .history-close {
            background: none;
            border: none;
            color: var(--gi-text-dim);
            cursor: pointer;
            font-size: 14px;
            padding: 2px 6px;
        }

        .history-close:hover {
            color: var(--gi-text-light);
        }

        .history-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 10px 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-msg {
            font-size: 12px;
            line-height: 1.6;
            padding: 6px 10px;
            border-radius: var(--gi-radius-sm);
            word-break: break-word;
        }

        .history-msg.user {
            align-self: flex-end;
            background: rgba(198, 169, 99, 0.15);
            border: 1px solid var(--gi-border-gold-dim);
            color: var(--gi-text-gold);
            max-width: 85%;
        }

        .history-msg.assistant {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.05);
            color: var(--gi-text-light);
            max-width: 85%;
        }

        /* â”€â”€ Bottom Dialogue Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dialogue-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0 0 20px;
            /*
             * Genshin-style radial shadow:
             *  - Centered on char name (50% horizontal, ~38% from top of this area)
             *  - Ellipse: wide horizontally (~65%), taller downward
             *  - Darkest at center, fades outward
             *  - Above name: fades quickly; below name: fades slowly
             */
            background: radial-gradient(ellipse 65% 80% at 50% 30%,
                    rgba(15, 17, 26, 0.88) 0%,
                    rgba(15, 17, 26, 0.75) 20%,
                    rgba(15, 17, 26, 0.45) 50%,
                    rgba(15, 17, 26, 0.15) 75%,
                    transparent 100%);
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            pointer-events: auto;
        }

        /* â”€â”€ Character Name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .char-name-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 24px;
            animation: gi-fadeIn 0.3s var(--gi-ease);
        }

        .char-name-line {
            width: 40px;
            height: 1px;
            background: linear-gradient(90deg,
                    transparent,
                    var(--gi-gold-dim) 40%,
                    var(--gi-gold) 100%);
        }

        .char-name-line.right {
            background: linear-gradient(90deg,
                    var(--gi-gold) 0%,
                    var(--gi-gold-dim) 60%,
                    transparent);
        }

        .char-name {
            font-family: var(--gi-font-serif);
            font-size: 18px;
            font-weight: 600;
            color: rgb(244, 197, 68);
            letter-spacing: 2px;
        }

        .char-title {
            font-size: 11px;
            color: var(--gi-text-dim);
            letter-spacing: 1px;
            margin-bottom: 10px;
            text-align: center;
        }

        /* â”€â”€ Dialogue Text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dialogue-text {
            max-width: 680px;
            width: 80%;
            text-align: center;
            font-size: 15px;
            line-height: 1.9;
            color: var(--gi-text-light);
            letter-spacing: 0.3px;
            min-height: 28px;
            margin-bottom: 16px;
            padding: 0 20px;
        }

        .dialogue-text .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 16px;
            background: var(--gi-text-gold);
            margin-left: 2px;
            vertical-align: middle;
            animation: gi-blink 0.8s step-end infinite;
        }

        @keyframes gi-blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* â”€â”€ Thinking Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .thinking-dots {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .thinking-dots .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--gi-text-gold);
            animation: gi-dotPulse 1.2s infinite;
        }

        .thinking-dots .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dots .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* â”€â”€ Input Area (right-side, like Genshin options) â”€â”€ */
        .input-area {
            position: fixed;
            right: 15%;
            bottom: 37%;
            width: 280px;
            display: flex;
            gap: 0;
        }

        .input-field {
            flex: 1;
            padding: 10px 18px;
            padding-right: 44px;
            background: var(--gi-dark-input);
            border: 1px solid var(--gi-border-gold-dim);
            border-radius: var(--gi-radius-md);
            color: var(--gi-text-light);
            font-family: var(--gi-font-sans);
            font-size: 14px;
            outline: none;
            transition: border-color var(--gi-duration) var(--gi-ease);
        }

        .input-field::placeholder {
            color: var(--gi-text-dim);
            font-size: 13px;
        }

        .input-field:focus {
            border-color: var(--gi-border-gold);
        }

        .send-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            color: var(--gi-text-gold);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all var(--gi-duration) var(--gi-ease);
            opacity: 0.6;
        }

        .send-btn:hover {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
        }

        /* â”€â”€ History Toggle Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .history-toggle {
            position: absolute;
            top: 12px;
            left: 16px;
            background: var(--gi-dark-panel);
            border: 1px solid var(--gi-border-gold-dim);
            border-radius: var(--gi-radius-sm);
            color: var(--gi-text-dim);
            font-family: var(--gi-font-sans);
            font-size: 11px;
            padding: 4px 12px;
            cursor: pointer;
            transition: all var(--gi-duration) var(--gi-ease);
            z-index: 10;
            letter-spacing: 0.5px;
        }

        .history-toggle:hover {
            color: var(--gi-text-gold);
            border-color: var(--gi-border-gold);
        }

        /* â”€â”€ Continue Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .continue-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .continue-indicator.visible {
            opacity: 1;
        }

        .continue-arrow {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid var(--gi-text-gold);
            animation: gi-bounce 1s infinite;
        }

        @keyframes gi-bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(4px);
            }
        }
    </style>
</head>

<body>
    <div class="dialogue-root" id="root">
        <!-- Top: History toggle -->
        <button class="history-toggle" id="historyToggle">ğŸ“œ å¯¹è¯è®°å½•</button>

        <!-- History Panel (hidden by default) -->
        <div class="history-panel hidden gi-scrollbar-dark" id="historyPanel">
            <div class="history-header">
                <span>â—† å¯¹è¯è®°å½•</span>
                <button class="history-close" id="historyClose">âœ•</button>
            </div>
            <div class="history-scroll gi-scrollbar-dark" id="historyScroll"></div>
        </div>

        <!-- Right-side Options -->
        <div class="options-area" id="optionsArea"></div>

        <!-- Bottom Dialogue Area -->
        <div class="dialogue-bottom" id="dialogueBottom">
            <!-- Thinking dots (shown when AI is processing) -->
            <div class="thinking-dots" id="thinkingDots" style="display:none">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>

            <!-- Character name -->
            <div class="char-name-row" id="charNameRow" style="display:none">
                <div class="char-name-line"></div>
                <span class="char-name" id="charName">Kokoro</span>
                <div class="char-name-line right"></div>
            </div>
            <div class="char-title" id="charTitle" style="display:none">AI åŠ©ç†</div>

            <!-- Dialogue text -->
            <div class="dialogue-text" id="dialogueText"></div>

            <!-- Continue indicator -->
            <div class="continue-indicator" id="continueIndicator">
                <div class="continue-arrow"></div>
            </div>

            <!-- Input area -->
            <div class="input-area">
                <input type="text" class="input-field" id="inputField" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯â€¦" autocomplete="off" />
                <button class="send-btn" id="sendBtn">â¤</button>
            </div>
        </div>
    </div>

    <!-- Kokoro Mod SDK -->
    <script src="http://mod.localhost/mod-sdk.js"></script>
    <script>
        (async () => {
            // â”€â”€ State â”€â”€
            let messages = [];        // Full chat history
            let currentText = '';     // Current streaming text
            let isStreaming = false;
            let showHistory = false;
            let charName = 'Kokoro';
            let charTitle = 'AI åŠ©ç†';

            // â”€â”€ DOM Elements â”€â”€
            const root = document.getElementById('root');
            const dialogueText = document.getElementById('dialogueText');
            const charNameEl = document.getElementById('charName');
            const charTitleEl = document.getElementById('charTitle');
            const charNameRow = document.getElementById('charNameRow');
            const inputField = document.getElementById('inputField');
            const sendBtn = document.getElementById('sendBtn');
            const optionsArea = document.getElementById('optionsArea');
            const thinkingDots = document.getElementById('thinkingDots');
            const historyToggle = document.getElementById('historyToggle');
            const historyPanel = document.getElementById('historyPanel');
            const historyClose = document.getElementById('historyClose');
            const historyScroll = document.getElementById('historyScroll');
            const continueIndicator = document.getElementById('continueIndicator');

            // â”€â”€ Quick reply patterns â”€â”€
            const quickReplies = [
                'ç»§ç»­è¯´ä¸‹å»ã€‚',
                'æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ',
                'è°¢è°¢ä½ ï¼',
            ];

            // â”€â”€ Render Functions â”€â”€

            function showDialogue(text, showCursor = false) {
                charNameRow.style.display = 'flex';
                charTitleEl.style.display = 'block';
                charNameEl.textContent = charName;
                charTitleEl.textContent = charTitle;
                dialogueText.innerHTML = text +
                    (showCursor ? '<span class="typing-cursor"></span>' : '');
            }

            function hideDialogue() {
                charNameRow.style.display = 'none';
                charTitleEl.style.display = 'none';
                dialogueText.textContent = '';
            }

            function showThinking() {
                thinkingDots.style.display = 'flex';
                hideDialogue();
            }

            function hideThinking() {
                thinkingDots.style.display = 'none';
            }

            function renderOptions() {
                optionsArea.innerHTML = '';

                // Show quick replies when not streaming and dialogue is visible
                if (!isStreaming && messages.length > 0) {
                    quickReplies.forEach(text => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.innerHTML = `
                            <span class="option-dots">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </span>
                            <span class="option-text">${text}</span>
                        `;
                        btn.addEventListener('click', () => sendMessage(text));
                        optionsArea.appendChild(btn);
                    });

                    // Custom input option
                    const customBtn = document.createElement('button');
                    customBtn.className = 'option-btn custom-input';
                    customBtn.innerHTML = `
                        <span class="option-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </span>
                        <span class="option-text">è‡ªå®šä¹‰è¾“å…¥</span>
                    `;
                    customBtn.addEventListener('click', () => {
                        inputField.focus();
                    });
                    optionsArea.appendChild(customBtn);
                }
            }

            function renderHistory() {
                historyScroll.innerHTML = '';
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `history-msg ${msg.role}`;
                    div.textContent = msg.content;
                    historyScroll.appendChild(div);
                });
                historyScroll.scrollTop = historyScroll.scrollHeight;
            }

            function toggleHistory() {
                showHistory = !showHistory;
                if (showHistory) {
                    historyPanel.classList.remove('hidden');
                    renderHistory();
                } else {
                    historyPanel.classList.add('hidden');
                }
            }

            // â”€â”€ Send Message â”€â”€
            function sendMessage(text) {
                if (!text || !text.trim()) return;

                const userMsg = { role: 'user', content: text.trim() };
                messages.push(userMsg);
                inputField.value = '';

                // Clear options
                optionsArea.innerHTML = '';

                // Show thinking
                showThinking();
                isStreaming = true;
                currentText = '';

                // Send to host via mod SDK
                Kokoro.action('send_message', { message: text.trim() });
            }

            // â”€â”€ Event: Input â”€â”€
            inputField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.isComposing) {
                    e.preventDefault();
                    sendMessage(inputField.value);
                }
            });

            sendBtn.addEventListener('click', () => {
                sendMessage(inputField.value);
            });

            // â”€â”€ Event: History â”€â”€
            historyToggle.addEventListener('click', toggleHistory);
            historyClose.addEventListener('click', toggleHistory);

            // â”€â”€ Event: Continue â”€â”€
            continueIndicator.addEventListener('click', () => {
                inputField.focus();
            });

            // â”€â”€ Mod SDK Events â”€â”€

            // Streaming delta
            Kokoro.on('chat-delta', (data) => {
                hideThinking();
                isStreaming = true;

                if (data && data.delta) {
                    currentText += data.delta;
                    showDialogue(currentText, true);
                }
            });

            // Stream complete
            Kokoro.on('chat-done', () => {
                isStreaming = false;

                if (currentText) {
                    showDialogue(currentText, false);
                    messages.push({ role: 'assistant', content: currentText });
                    currentText = '';

                    // Show continue indicator briefly
                    continueIndicator.classList.add('visible');
                    setTimeout(() => {
                        continueIndicator.classList.remove('visible');
                    }, 3000);
                }

                hideThinking();
                renderOptions();

                if (showHistory) {
                    renderHistory();
                }
            });

            // Prop updates from host
            Kokoro.on('update', (props) => {
                if (props && props.characterName) {
                    charName = props.characterName;
                }
                if (props && props.characterTitle) {
                    charTitle = props.characterTitle;
                }
            });

            // â”€â”€ Initial State â”€â”€
            charNameRow.style.display = 'flex';
            charNameEl.textContent = charName;
            charNameEl.style.color = 'rgb(244, 197, 68)';

            Kokoro.log('Genshin dialogue UI loaded');
        })();
    </script>
</body>

</html>